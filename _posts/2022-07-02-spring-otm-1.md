---
layout: post
title: "Spring: Entity OneToMany(일대다) 관계 정리"
categories: [Dev, Spring]
tags: [spring, jpa, entity]

---

# OneToMany

![relation](/assets/img/220702-1-1.png)

위 처럼 일대다 관계를 가지는 Entity를 작성하는 방법과 차이점에 대한 정리

# 기본 동작(by JoinTable)

```kotlin
@Entity
class Student(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    var id: Long,
    var name: String
)

@Entity
class Class(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    var id: Long,
    @OneToMany
    var students: MutableSet<Student> = mutableSetOf()
)
```

### 결과

```sql
create table class (
    id bigint generated by default as identity,
    primary key (id)
)

create table class_students (
    class_id bigint not null,
    students_id bigint not null,
    primary key (class_id, students_id)
)

create table student (
   id bigint generated by default as identity,
    name varchar(255),
    primary key (id)
)
```

![join-table](/assets/img/220702-1-2.png)

JoinTable 기반으로 동작하며 생성되는 Table은 위와 같다.

# MappedBy

자식(여기서는 student) entity에서 부모 entity의 정보를 포함하는것을 원하는경우 사용 할 수 있는 방법

```kotlin
@Entity
class Student(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    var id: Long,
    var name: String,
    var classId: Long
    or
    @ManyToOne
    var `class`: Class
)

@Entity
class Class(
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    var id: Long,
    @OneToMany(mappedBy = "classId")
    var students: MutableSet<Student> = mutableSetOf()
    or
    @OneToMany(mappedBy = "class")
    var students: MutableSet<Student> = mutableSetOf()
)
```

```sql
create table class (
   id bigint generated by default as identity,
    primary key (id)
)

create table student (
   id bigint generated by default as identity,
    name varchar(255),
    class_id bigint not null,
    primary key (id)
)
```

![mapped-by](/assets/img/220702-1-3.png)

# Query 비교

### INESRT - JOIN TABLE

```kotlin
val `class` = classRepository.save(Class())
val students = studentRepository.saveAll(
    mutableListOf(
        Student(name = "a"),
        Student(name = "b"),
        Student(name = "c"),
    )
).toMutableSet()

`class`.students = students
```

```kotlin
Hibernate: insert into class (id) values (default)
Hibernate: insert into student (id, name) values (default, ?)
Hibernate: insert into student (id, name) values (default, ?)
Hibernate: insert into student (id, name) values (default, ?)
Hibernate: insert into class_students (class_id, students_id) values (?, ?)
Hibernate: insert into class_students (class_id, students_id) values (?, ?)
Hibernate: insert into class_students (class_id, students_id) values (?, ?)
```

### INESRT - MappedBy

```kotlin
val `class` = classRepository.save(Class())
val students = studentRepository.saveAll(
    mutableListOf(
        Student(name = "a", `class` = `class`),
        Student(name = "b", `class` = `class`),
        Student(name = "c", `class` = `class`),
    )
).toMutableSet()

`class`.students = students
```

```sql
Hibernate: insert into class (id) values (default)
Hibernate: insert into student (id, class_id, name) values (default, ?, ?)
Hibernate: insert into student (id, class_id, name) values (default, ?, ?)
Hibernate: insert into student (id, class_id, name) values (default, ?, ?)
```

> *FetchType은 따로 지정하지않고 기본값(LAZY)으로 비교진행*
>

### SELECT - JOIN TABLE

```sql
Hibernate: select class0_.id as id1_0_0_ from class class0_ where class0_.id=?
Hibernate: select students0_.class_id as class_id1_1_0_, students0_.students_id as students2_1_0_, student1_.id as id1_2_1_, student1_.name as name2_2_1_ from class_students students0_ inner join student student1_ on students0_.students_id=student1_.id where students0_.class_id=?
```

### SELECT - MappedBy

```sql
Hibernate: select class0_.id as id1_0_0_ from class class0_ where class0_.id=?
Hibernate: select students0_.class_id as class_id3_1_0_, students0_.id as id1_1_0_, students0_.id as id1_1_1_, students0_.class_id as class_id3_1_1_, students0_.name as name2_1_1_ from student students0_ where students0_.class_id=?
```
